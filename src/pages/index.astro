---
import { BlogPost } from '../types'
import { List } from 'immutable'
import { DateTime } from 'luxon'
import BaseHead from '../components/BaseHead.astro'
import BaseLayout from '../layouts/BaseLayout.astro'

const mds = await Astro.glob<BlogPost>('./blog/*.(md|mdx)')
const publishablePosts = List(mds)
	.map(post => ({
		title: post.frontmatter.title,
		href: post.url,
		draft: post.frontmatter.draft,
		date: DateTime.fromISO(post.frontmatter.date).toISODate(),
	}))
	.filter(post => !post.draft)
	.sort((postA, postB) => {
		const dateA = new Date(postA.date)
		const dateB = new Date(postB.date)

		return dateB.valueOf() - dateA.valueOf()
	})
	.toJS()

const headProps = {
	title: "Roberto Tonino's corner",
	description: "The homepage of Roberto Tonino's website.",
	permalink: new URL(Astro.url.pathname, Astro.site),
}
---

<html lang="en">
	<head>
		<BaseHead {...headProps} />

		<style lang="scss">
			.published-post {
				&:not([data-new]) {
					@apply border-primary-600;
				}

				&[data-new] {
					border-color: gold;
					background-color: hsl(51deg 100% 50% / 10%);
					position: relative;

					&::before {
						content: 'NEW';
						line-height: 1;
						opacity: 0.5;
						position: absolute;
						right: 0.5em;
						top: 0.5em;
					}
				}
			}
		</style>
	</head>
	<body>
		<BaseLayout>
			<section class="container px-2 sm:px-6">
				<h1 class="mb-12" set:html={headProps.title}></h1>

				<h2 class="mb-10">Blog posts</h2>
				<div class="space-y-8">
					{
						publishablePosts.map(({ title, href, date }) => (
							<a
								rel="prefetch"
								href={href}
								class="published-post block border-solid p-4 text-foreground no-underline hover:bg-white hover:bg-opacity-10"
							>
								<h3>{title}</h3>
								<time datetime={date} class="published-post__date text-xs capitalize text-opacity-75">
									{date}
								</time>
							</a>
						))
					}
				</div>
			</section>
		</BaseLayout>

		<script>
			const ONE_WEEK = 1000 * 60 * 60 * 24 * 7
			const $dateEls = document.querySelectorAll('.published-post__date') as unknown as HTMLTimeElement[]

			$dateEls.forEach($dateEl => {
				const $parent = $dateEl.parentElement
				const date = $dateEl.getAttribute('datetime')
				const epoch = new Date(date).valueOf()
				const isNew = epoch > Date.now() - ONE_WEEK
				const options = {
					weekday: 'long',
					year: 'numeric',
					month: 'long',
					day: 'numeric',
				}
				// @ts-expect-error No options needs to be of type DateTimeFormatOptions
				const localeDate = new Date(date).toLocaleString(window.navigator.language, options)

				$dateEl.innerText = localeDate

				if (isNew) {
					$parent.dataset.new = ''
				}
			})
		</script>
	</body>
</html>
